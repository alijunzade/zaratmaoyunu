<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Boyama Sava≈ülarƒ±: Global Risk</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');

        :root {
            --bg-gradient: linear-gradient(135deg, #81ecec 0%, #74b9ff 100%);
            --panel-bg: rgba(255, 255, 255, 0.95);
            --p1-color: #ff7675;
            --p2-color: #74b9ff;
        }

        body {
            margin: 0; overflow: hidden; font-family: 'Fredoka', sans-serif;
            background: var(--bg-gradient); display: flex; justify-content: center;
            align-items: center; height: 100vh; user-select: none; touch-action: none;
        }

        /* --- OYUN ALANI --- */
        #gameLayout {
            display: flex; gap: 20px; align-items: center; width: 95vw; max-width: 1200px; height: 90vh;
        }

        #canvasWrapper {
            flex-grow: 1; height: 100%; background: #e3f2fd;
            border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            position: relative; overflow: hidden; border: 8px solid #fff;
        }

        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 22px; }
        #uiCanvas { cursor: crosshair; }

        /* --- SAƒû PANEL --- */
        #sidePanel {
            width: 320px; display: flex; flex-direction: column; gap: 12px;
        }

        .info-card {
            background: var(--panel-bg); padding: 12px 15px; border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: transform 0.3s;
            border-left: 8px solid #ddd;
        }
        .player-card.active { transform: scale(1.03); border-color: gold !important; box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
        
        .card-content { display: flex; align-items: center; gap: 15px; }
        .flag { font-size: 28px; }
        .stats h3 { margin: 0; font-size: 15px; color: #2d3436; }
        .stats p { margin: 0; font-size: 13px; color: #636e72; font-weight: bold; }

        /* Limit G√∂stergesi */
        .limit-bar-bg { width: 100%; height: 6px; background: #eee; border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .limit-bar-fill { height: 100%; width: 0%; background: #00b894; transition: width 0.1s, background 0.3s; }

        #turnBadge {
            background: #6c5ce7; color: white; text-align: center; padding: 12px;
            border-radius: 15px; font-size: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Butonlar */
        .btn-group { display: flex; gap: 10px; }
        .icon-btn {
            background: white; border: none; padding: 10px; border-radius: 12px;
            cursor: pointer; font-size: 18px; flex: 1; box-shadow: 0 4px 0 #b2bec3;
            transition: transform 0.1s;
        }
        .icon-btn:active { transform: translateY(4px); box-shadow: none; }

        #actionArea { margin-top: auto; text-align: center; }
        
        /* ZAR */
        .dice-box { width: 70px; height: 70px; margin: 0 auto 10px; position: relative; transform-style: preserve-3d; transition: transform 1s ease-out; }
        .dice-face {
            position: absolute; width: 100%; height: 100%; background: white;
            border: 2px solid #ddd; border-radius: 12px; display: flex;
            justify-content: center; align-items: center; font-size: 24px; font-weight: bold;
        }
        .df1 { transform: translateZ(35px); }
        .df2 { transform: rotateY(180deg) translateZ(35px); }
        .df3 { transform: rotateY(90deg) translateZ(35px); }
        .df4 { transform: rotateY(-90deg) translateZ(35px); }
        .df5 { transform: rotateX(90deg) translateZ(35px); }
        .df6 { transform: rotateX(-90deg) translateZ(35px); }

        #rollBtn {
            width: 100%; padding: 15px; border: none; border-radius: 15px;
            background: #dfe6e9; color: #636e72; font-size: 16px; font-weight: bold;
            cursor: not-allowed; transition: all 0.3s; box-shadow: 0 5px 0 #b2bec3;
        }
        #rollBtn.ready { background: #00b894; color: white; cursor: pointer; box-shadow: 0 5px 0 #008f72; animation: bounce 1s infinite; }
        #rollBtn:active { transform: translateY(5px); box-shadow: none; }

        /* --- POPUPS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center; z-index: 100;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }

        .modal-card {
            background: white; padding: 30px; border-radius: 30px; text-align: center;
            max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-overlay.active .modal-card { transform: scale(1); }

        .rules-list { text-align: left; background: #f1f2f6; padding: 20px; border-radius: 15px; margin: 20px 0; }
        .rules-list li { margin-bottom: 10px; color: #555; font-size: 14px; }
        .rules-list b { color: #2d3436; }

        /* SETUP SCREEN */
        .setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .player-select { background: #f8f9fa; padding: 15px; border-radius: 15px; border: 3px solid transparent; }
        .p1-sel { border-color: var(--p1-color); }
        .p2-sel { border-color: var(--p2-color); }
        select { width: 100%; padding: 8px; border-radius: 8px; margin-top: 5px; }

        .primary-btn {
            background: linear-gradient(45deg, #6c5ce7, #a29bfe); color: white; border: none;
            padding: 12px 40px; font-size: 18px; border-radius: 50px; cursor: pointer;
            transition: transform 0.2s; box-shadow: 0 10px 20px rgba(108, 92, 231, 0.3);
        }
        .primary-btn:hover { transform: scale(1.05); }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

        @media (max-width: 768px) {
            #gameLayout { flex-direction: column; height: 95vh; }
            #sidePanel { width: 100%; flex-direction: row; flex-wrap: wrap; justify-content: center; }
            .info-card { flex: 1; min-width: 140px; }
            #actionArea { width: 100%; display: flex; align-items: center; gap: 10px; padding: 0 10px; }
            .dice-box { width: 50px; height: 50px; margin: 0; }
            .df1 { transform: translateZ(25px); } .df2 { transform: rotateY(180deg) translateZ(25px); } /* vb... mobilde basit tut */
            #rollBtn { padding: 10px; font-size: 14px; }
        }
    </style>
</head>
<body>

    <div id="setupModal" class="modal-overlay active">
        <div class="modal-card">
            <h1 style="color:#6c5ce7; margin:0;">üåç Boyama Sava≈ülarƒ±</h1>
            <p style="color:#636e72;">√úlkeni se√ß ve stratejini konu≈ütur!</p>
            
            <div class="setup-grid">
                <div class="player-select p1-sel">
                    <h4 style="margin:0; color:#ff7675">Oyuncu 1</h4>
                    <div style="font-size:40px; margin:10px 0;" id="p1FlagPreview">‚ùì</div>
                    <select id="p1Select" onchange="updatePreview('p1')"></select>
                </div>
                <div class="player-select p2-sel">
                    <h4 style="margin:0; color:#74b9ff">Oyuncu 2</h4>
                    <div style="font-size:40px; margin:10px 0;" id="p2FlagPreview">‚ùì</div>
                    <select id="p2Select" onchange="updatePreview('p2')"></select>
                </div>
            </div>

            <div class="rules-list" style="font-size:13px; padding:10px;">
                üé® <b>Nasƒ±l Oynanƒ±r:</b> Kendi renginden ba≈ülayarak rakip alana doƒüru √ßizim yap.<br>
                üé≤ <b>Risk:</b> Zar at! Tek gelirse kazanƒ±rsƒ±n, √ßift gelirse √ßizdiƒüin yer silinir.<br>
                üìè <b>Limit:</b> Kendi alanƒ±n kadar b√ºy√ºk bir yeri riske edebilirsin.
            </div>

            <button class="primary-btn" onclick="finishSetup()">SAVA≈ûA BA≈ûLA üöÄ</button>
        </div>
    </div>

    <div id="infoModal" class="modal-overlay">
        <div class="modal-card">
            <h2>üìú Oyun Kurallarƒ±</h2>
            <div class="rules-list">
                <ol style="padding-left:20px;">
                    <li><b>Sƒ±ra Sende:</b> Kendi rengine tƒ±klayƒ±p basƒ±lƒ± tutarak, fethetmek istediƒüin alanƒ± √ßiz.</li>
                    <li><b>Limitler:</b> Sahip olduƒüun toplam alanƒ±n %120'si kadar b√ºy√ºkl√ºkte bir √ßizim yapabilirsin. √áok b√ºy√ºk √ßizersen kalem durur!</li>
                    <li><b>Zar Atma:</b> √áizim bitince 'Zar At' butonu a√ßƒ±lƒ±r.</li>
                    <li><b>Sonu√ßlar:</b>
                        <ul>
                            <li>üé≤ 1, 3, 5: <b>KAZAN√á</b> (Alan senin olur)</li>
                            <li>üé≤ 2, 4, 6: <b>KAYIP</b> (Ba≈üladƒ±ƒüƒ±n yerden silinir)</li>
                        </ul>
                    </li>
                </ol>
            </div>
            <button class="primary-btn" onclick="toggleInfo(false)">ANLADIM üëç</button>
        </div>
    </div>

    <div id="gameLayout">
        <div id="canvasWrapper">
            <canvas id="bgCanvas"></canvas>
            <canvas id="mapCanvas"></canvas>
            <canvas id="uiCanvas"></canvas>
            <canvas id="fxCanvas" style="pointer-events: none;"></canvas>
        </div>

        <div id="sidePanel">
            <div id="turnBadge">Hazƒ±rlanƒ±yor...</div>
            
            <div class="btn-group">
                <button class="icon-btn" onclick="toggleInfo(true)" title="Kurallar">‚ùì Nasƒ±l Oynanƒ±r?</button>
            </div>

            <div id="p1Card" class="info-card player-card active" style="border-color: var(--p1-color);">
                <div class="card-content">
                    <div class="flag" id="p1FlagDisp">üè≥Ô∏è</div>
                    <div class="stats" style="flex-grow:1">
                        <h3 id="p1NameDisp">Oyuncu 1</h3>
                        <p id="p1Score">150 px</p>
                    </div>
                </div>
                <div class="limit-bar-bg"><div id="p1LimitBar" class="limit-bar-fill"></div></div>
            </div>

            <div id="p2Card" class="info-card player-card" style="border-color: var(--p2-color);">
                <div class="card-content">
                    <div class="flag" id="p2FlagDisp">üè≥Ô∏è</div>
                    <div class="stats" style="flex-grow:1">
                        <h3 id="p2NameDisp">Oyuncu 2</h3>
                        <p id="p2Score">150 px</p>
                    </div>
                </div>
                <div class="limit-bar-bg"><div id="p2LimitBar" class="limit-bar-fill"></div></div>
            </div>

            <div id="actionArea">
                <div class="dice-box" id="gameDice">
                    <div class="dice-face df1">1</div>
                    <div class="dice-face df2">2</div>
                    <div class="dice-face df3">3</div>
                    <div class="dice-face df4">4</div>
                    <div class="dice-face df5">5</div>
                    <div class="dice-face df6">6</div>
                </div>
                <button id="rollBtn">√ñNCE ALAN √áƒ∞Z üñåÔ∏è</button>
            </div>
        </div>
    </div>

<script>
// --- VERƒ∞LER ---
const COUNTRIES = [
    { code: 'TR', name: 'T√ºrkiye', flag: 'üáπüá∑' },
    { code: 'AZ', name: 'Azerbaycan', flag: 'üá¶üáø' },
    { code: 'US', name: 'ABD', flag: 'üá∫üá∏' },
    { code: 'DE', name: 'Almanya', flag: 'üá©üá™' },
    { code: 'JP', name: 'Japonya', flag: 'üáØüáµ' },
    { code: 'KR', name: 'G√ºney Kore', flag: 'üá∞üá∑' },
    { code: 'BR', name: 'Brezilya', flag: 'üáßüá∑' },
    { code: 'RU', name: 'Rusya', flag: 'üá∑üá∫' },
    { code: 'CN', name: '√áin', flag: 'üá®üá≥' },
    { code: 'FR', name: 'Fransa', flag: 'üá´üá∑' },
    { code: 'GB', name: 'Birle≈üik Krallƒ±k', flag: 'üá¨üáß' },
    { code: 'IT', name: 'ƒ∞talya', flag: 'üáÆüáπ' },
    { code: 'ES', name: 'ƒ∞spanya', flag: 'üá™üá∏' },
    { code: 'CA', name: 'Kanada', flag: 'üá®üá¶' },
    { code: 'AU', name: 'Avustralya', flag: 'üá¶üá∫' },
    { code: 'IN', name: 'Hindistan', flag: 'üáÆüá≥' },
    { code: 'MX', name: 'Meksika', flag: 'üá≤üáΩ' },
    { code: 'ID', name: 'Endonezya', flag: 'üáÆüá©' },
    { code: 'SA', name: 'Suudi Arabistan', flag: 'üá∏üá¶' },
    { code: 'ZA', name: 'G√ºney Afrika', flag: 'üáøüá¶' }
];

// --- SETUP ---
const p1Sel = document.getElementById('p1Select');
const p2Sel = document.getElementById('p2Select');

COUNTRIES.forEach((c, i) => {
    p1Sel.add(new Option(c.name, i));
    p2Sel.add(new Option(c.name, i));
});
p1Sel.selectedIndex = 0; // TR
p2Sel.selectedIndex = 1; // AZ
updatePreview('p1'); updatePreview('p2');

function updatePreview(p) {
    const idx = document.getElementById(p+'Select').value;
    document.getElementById(p+'FlagPreview').innerText = COUNTRIES[idx].flag;
}

function toggleInfo(show) {
    const el = document.getElementById('infoModal');
    if(show) el.classList.add('active'); else el.classList.remove('active');
}

let player1 = {}, player2 = {};
let audioCtx;

function finishSetup() {
    const idx1 = p1Sel.value;
    const idx2 = p2Sel.value;
    
    player1 = { ...COUNTRIES[idx1], color: '#ff7675' };
    player2 = { ...COUNTRIES[idx2], color: '#74b9ff' };

    document.getElementById('p1NameDisp').innerText = player1.name;
    document.getElementById('p1FlagDisp').innerText = player1.flag;
    document.getElementById('p2NameDisp').innerText = player2.name;
    document.getElementById('p2FlagDisp').innerText = player2.flag;
    
    document.getElementById('setupModal').classList.remove('active');
    
    initAudio();
    gameState.started = true;
    resize();
    updateTurnIndicator();
    playTone(600, 'sine', 0.2); // Start sound
}

// --- SES (Sweet Sounds) ---
function initAudio() {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
function playTone(freq, type, duration, delay = 0) {
    if (!audioCtx) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime + delay);
    gain.gain.setValueAtTime(0, audioCtx.currentTime + delay);
    gain.gain.linearRampToValueAtTime(0.15, audioCtx.currentTime + delay + 0.05);
    gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + delay + duration);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(audioCtx.currentTime + delay); osc.stop(audioCtx.currentTime + delay + duration);
}
function playSound(ev) {
    if(ev==='draw') playTone(300+Math.random()*100, 'sine', 0.08);
    if(ev==='ready') { playTone(523, 'triangle', 0.1); playTone(659, 'triangle', 0.1, 0.1); }
    if(ev==='win') { playTone(523, 'sine', 0.3); playTone(659, 'sine', 0.3, 0.1); playTone(784, 'sine', 0.5, 0.2); }
    if(ev==='lose') { playTone(493, 'triangle', 0.3); playTone(466, 'triangle', 0.5, 0.2); }
    if(ev==='limit') { playTone(200, 'sawtooth', 0.1); }
}

// --- OYUN MOTORU ---
const bgCanvas = document.getElementById('bgCanvas');
const mapCanvas = document.getElementById('mapCanvas');
const uiCanvas = document.getElementById('uiCanvas');
const fxCanvas = document.getElementById('fxCanvas');
const ctxBg = bgCanvas.getContext('2d');
const ctxMap = mapCanvas.getContext('2d', { willReadFrequently: true });
const ctxUi = uiCanvas.getContext('2d');
const ctxFx = fxCanvas.getContext('2d');

let gameState = {
    started: false,
    turn: 'p1',
    isDrawing: false,
    pathPoints: [],
    canRoll: false,
    isRolling: false,
    scores: { p1: 500, p2: 500 }, // Ba≈ülangƒ±√ßta biraz y√ºksek ver ki ilk √ßizim rahat olsun
    limitRatio: 1.2 // %120 Risk Hakkƒ±
};

function generateMap() {
    ctxBg.clearRect(0,0,bgCanvas.width, bgCanvas.height);
    // G√∂ller
    ctxBg.fillStyle = '#b3e5fc';
    for(let i=0; i<4; i++) {
        let x = Math.random()*bgCanvas.width, y = Math.random()*bgCanvas.height;
        if(Math.abs(x)<200 && Math.abs(y-bgCanvas.height)<200) continue; // P1 alanƒ± koru
        ctxBg.beginPath(); ctxBg.arc(x,y, 40+Math.random()*50, 0, Math.PI*2); ctxBg.fill();
    }
    // Emojiler
    ctxBg.font = "24px Arial"; ctxBg.textAlign="center";
    for(let i=0; i<20; i++) {
        ctxBg.fillText(Math.random()>0.6?"üå≤":"‚õ∞Ô∏è", Math.random()*bgCanvas.width, Math.random()*bgCanvas.height);
    }
}

function resize() {
    const w = document.getElementById('canvasWrapper');
    [bgCanvas, mapCanvas, uiCanvas, fxCanvas].forEach(c => { c.width = w.clientWidth; c.height = w.clientHeight; });
    if(gameState.started) { generateMap(); drawInitialAreas(); }
}
window.addEventListener('resize', resize);

function drawInitialAreas() {
    // P1
    ctxMap.fillStyle = player1.color;
    ctxMap.beginPath(); ctxMap.arc(0, mapCanvas.height, 160, 0, Math.PI*2); ctxMap.fill();
    // P2
    ctxMap.fillStyle = player2.color;
    ctxMap.beginPath(); ctxMap.arc(mapCanvas.width, 0, 160, 0, Math.PI*2); ctxMap.fill();
    
    // Skorlarƒ± kesin g√ºncelle
    setTimeout(updateScores, 100);
}

// --- DRAWING LOGIC (D√úZELTƒ∞LDƒ∞) ---
function getMousePos(e) {
    const r = uiCanvas.getBoundingClientRect();
    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: cx - r.left, y: cy - r.top };
}

uiCanvas.addEventListener('mousedown', startD); uiCanvas.addEventListener('mousemove', moveD); uiCanvas.addEventListener('mouseup', endD);
uiCanvas.addEventListener('touchstart', startD, {passive:false}); uiCanvas.addEventListener('touchmove', moveD, {passive:false}); uiCanvas.addEventListener('touchend', endD);

function startD(e) {
    if(!gameState.started || gameState.canRoll || gameState.isRolling) return;
    if(e.type==='touchstart') e.preventDefault();
    const p = getMousePos(e);
    
    if(!isPointInPlayerArea(p.x, p.y, gameState.turn)) return; // Sadece kendi alanƒ±ndan ba≈üla

    gameState.isDrawing = true;
    gameState.pathPoints = [p];
    playSound('draw');

    ctxUi.beginPath(); ctxUi.moveTo(p.x, p.y);
    ctxUi.strokeStyle = '#2d3436'; ctxUi.lineWidth = 3; ctxUi.setLineDash([5,5]);
}

function moveD(e) {
    if(!gameState.isDrawing) return;
    if(e.type==='touchmove') e.preventDefault();
    
    const p = getMousePos(e);
    
    // Lƒ∞Mƒ∞T KONTROL√ú (D√úZELTƒ∞LDƒ∞)
    // Anlƒ±k √ßizilen alanƒ± hesapla
    gameState.pathPoints.push(p); // Ge√ßici ekle
    const currentDrawArea = calculatePolyArea(gameState.pathPoints);
    const maxAllowed = gameState.scores[gameState.turn] * gameState.limitRatio;
    
    // UI Bar G√ºncelle
    const ratio = Math.min(100, (currentDrawArea / maxAllowed) * 100);
    const barId = gameState.turn === 'p1' ? 'p1LimitBar' : 'p2LimitBar';
    const bar = document.getElementById(barId);
    bar.style.width = ratio + '%';

    if(currentDrawArea > maxAllowed) {
        // Limit a≈üƒ±ldƒ±!
        gameState.pathPoints.pop(); // Son noktayƒ± iptal et
        ctxUi.strokeStyle = 'red'; // Uyarƒ± rengi
        bar.style.background = 'red';
        if(Math.random()>0.8) playSound('limit'); // Ara sƒ±ra uyarƒ± sesi
    } else {
        // Devam et
        bar.style.background = '#00b894';
        ctxUi.strokeStyle = '#2d3436';
    }

    // √áizim
    ctxUi.clearRect(0,0,uiCanvas.width, uiCanvas.height);
    ctxUi.beginPath();
    ctxUi.moveTo(gameState.pathPoints[0].x, gameState.pathPoints[0].y);
    for(let pt of gameState.pathPoints) ctxUi.lineTo(pt.x, pt.y);
    ctxUi.stroke();
}

function endD() {
    if(!gameState.isDrawing) return;
    gameState.isDrawing = false;
    ctxUi.closePath();
    
    // Alanƒ± hesapla
    const area = calculatePolyArea(gameState.pathPoints);
    const maxAllowed = gameState.scores[gameState.turn] * gameState.limitRatio;

    // Barƒ± sƒ±fƒ±rla
    document.getElementById('p1LimitBar').style.width = '0%';
    document.getElementById('p2LimitBar').style.width = '0%';

    // √áok k√º√ß√ºkse veya limit a≈üƒ±rƒ±ysa iptal (ger√ßi moveD'de engelledik ama double check)
    if(area < 100) {
        ctxUi.clearRect(0,0,uiCanvas.width, uiCanvas.height);
        return;
    }

    // Alanƒ± g√∂ster
    ctxUi.fillStyle = 'rgba(0,0,0,0.1)'; ctxUi.fill();
    gameState.canRoll = true;
    playSound('ready');
    
    const btn = document.getElementById('rollBtn');
    btn.classList.add('ready');
    btn.innerHTML = `üé≤ ZAR AT (~${Math.floor(area/10)} br¬≤)`;
}

// --- DICE & RESULTS ---
document.getElementById('rollBtn').addEventListener('click', () => {
    if(!gameState.canRoll) return;
    gameState.isRolling = true;
    document.getElementById('rollBtn').classList.remove('ready');
    
    const diceBox = document.getElementById('gameDice');
    const result = Math.floor(Math.random()*6)+1;
    
    const xr = (Math.random()*720)+720; const yr = (Math.random()*720)+720;
    let fx=0, fy=0;
    if(result==1) {fx=0; fy=0;} if(result==2) {fx=0; fy=180;}
    if(result==3) {fx=0; fy=-90;} if(result==4) {fx=0; fy=90;}
    if(result==5) {fx=-90; fy=0;} if(result==6) {fx=90; fy=0;}
    
    diceBox.style.transform = `rotateX(${xr+fx}deg) rotateY(${yr+fy}deg)`;
    setTimeout(() => applyResult(result), 1200);
});

function applyResult(res) {
    const isWin = (res % 2 !== 0); // 1,3,5 Kazanƒ±r
    const center = gameState.pathPoints[0];
    
    if(isWin) {
        playSound('win');
        spawnParticles(center.x, center.y, gameState.turn==='p1'?player1.color:player2.color);
        
        ctxMap.globalCompositeOperation = 'source-over';
        ctxMap.fillStyle = gameState.turn==='p1'?player1.color:player2.color;
        ctxMap.beginPath();
        ctxMap.moveTo(gameState.pathPoints[0].x, gameState.pathPoints[0].y);
        for(let p of gameState.pathPoints) ctxMap.lineTo(p.x, p.y);
        ctxMap.closePath();
        ctxMap.fill();
    } else {
        playSound('lose');
        spawnParticles(center.x, center.y, '#555');
        
        // Silme i≈ülemi (Ba≈ülangƒ±√ß noktasƒ±ndan, √ßizilen alan b√ºy√ºkl√ºƒü√º kadar daire sil)
        ctxMap.globalCompositeOperation = 'destination-out';
        const area = calculatePolyArea(gameState.pathPoints);
        const r = Math.sqrt(area / Math.PI);
        ctxMap.beginPath(); ctxMap.arc(center.x, center.y, r, 0, Math.PI*2); ctxMap.fill();
        ctxMap.globalCompositeOperation = 'source-over';
    }
    
    setTimeout(() => {
        ctxUi.clearRect(0,0,uiCanvas.width, uiCanvas.height);
        gameState.pathPoints = [];
        gameState.canRoll = false;
        gameState.isRolling = false;
        document.getElementById('rollBtn').innerHTML = "√ñNCE ALAN √áƒ∞Z üñåÔ∏è";
        updateScores();
        switchTurn();
    }, 1500);
}

// --- UTILS ---
function isPointInPlayerArea(x, y, p) {
    const d = ctxMap.getImageData(x,y,1,1).data;
    if(d[3]<50) return false;
    // P1: Red dominant, P2: Blue/Green dominant
    return p==='p1' ? (d[0]>d[2]) : (d[2]>d[0]);
}

function calculatePolyArea(pts) {
    let area = 0;
    for (let i = 0; i < pts.length; i++) {
        let j = (i + 1) % pts.length;
        area += pts[i].x * pts[j].y;
        area -= pts[j].x * pts[i].y;
    }
    return Math.abs(area / 2);
}

function updateScores() {
    const d = ctxMap.getImageData(0,0,mapCanvas.width, mapCanvas.height).data;
    let s1=0, s2=0;
    for(let i=0; i<d.length; i+=400) { // Optimize scan
        if(d[i+3]>50) { if(d[i]>d[i+2]) s1++; else s2++; }
    }
    // Score scaling
    gameState.scores.p1 = s1 * 10;
    gameState.scores.p2 = s2 * 10;
    
    document.getElementById('p1Score').innerText = Math.floor(s1/10) + " px";
    document.getElementById('p2Score').innerText = Math.floor(s2/10) + " px";
    
    // Game Over
    if(s1 < 50 && gameState.started) alert(player2.name + " KAZANDI!");
    if(s2 < 50 && gameState.started) alert(player1.name + " KAZANDI!");
}

function switchTurn() {
    gameState.turn = gameState.turn === 'p1' ? 'p2' : 'p1';
    updateTurnIndicator();
}

function updateTurnIndicator() {
    const badge = document.getElementById('turnBadge');
    document.getElementById('p1Card').classList.remove('active');
    document.getElementById('p2Card').classList.remove('active');
    
    if(gameState.turn === 'p1') {
        badge.innerHTML = `Sƒ±ra: ${player1.flag} ${player1.name}`;
        badge.style.background = player1.color;
        document.getElementById('p1Card').classList.add('active');
    } else {
        badge.innerHTML = `Sƒ±ra: ${player2.flag} ${player2.name}`;
        badge.style.background = player2.color;
        document.getElementById('p2Card').classList.add('active');
    }
}

// --- PARTICLES ---
let particles = [];
function spawnParticles(x,y,c) {
    for(let i=0;i<20;i++) particles.push({x:x,y:y,vx:(Math.random()-.5)*10,vy:(Math.random()-.5)*10,life:1,c:c});
}
function loopFx() {
    ctxFx.clearRect(0,0,fxCanvas.width,fxCanvas.height);
    particles.forEach(p=>{
        p.x+=p.vx; p.y+=p.vy; p.life-=0.05;
        ctxFx.globalAlpha=p.life; ctxFx.fillStyle=p.c; 
        ctxFx.beginPath(); ctxFx.arc(p.x,p.y,4,0,Math.PI*2); ctxFx.fill();
    });
    particles=particles.filter(p=>p.life>0);
    requestAnimationFrame(loopFx);
}
loopFx();

</script>
</body>
</html>