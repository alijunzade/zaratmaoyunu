<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Boyama Sava≈ülarƒ±: Global Risk</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');

        :root {
            --bg-ocean: #2c3e50;
            --p1-color: #ff7675; /* Pastel Kƒ±rmƒ±zƒ± */
            --p2-color: #74b9ff; /* Pastel Mavi */
            --panel-bg: rgba(255, 255, 255, 0.95);
        }

        body {
            margin: 0; overflow: hidden; font-family: 'Fredoka', sans-serif;
            background: linear-gradient(135deg, #1e272e 0%, #485460 100%);
            display: flex; flex-direction: column;
            height: 100vh; user-select: none; touch-action: none;
        }

        /* --- √úST G√ú√á BARI --- */
        #tugOfWarBar {
            width: 100%; height: 24px; display: flex;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 50; background: #333;
        }
        #barP1 { height: 100%; background: var(--p1-color); width: 50%; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; justify-content: flex-start; padding-left: 10px; color: white; font-size: 11px; white-space: nowrap; overflow: hidden; font-weight:bold;}
        #barP2 { height: 100%; background: var(--p2-color); width: 50%; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; color: #333; font-size: 11px; white-space: nowrap; overflow: hidden; font-weight:bold;}
        
        /* --- OYUN ALANI --- */
        #gameLayout {
            display: flex; gap: 15px; align-items: center; justify-content: center;
            flex-grow: 1; padding: 15px; width: 100%; box-sizing: border-box;
        }

        #canvasWrapper {
            flex-grow: 1; height: 100%; background: #81ecec; /* Okyanus Rengi */
            border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            position: relative; overflow: hidden; border: 6px solid #fff;
        }

        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 14px; }
        #uiCanvas { cursor: crosshair; }

        /* --- SAƒû PANEL --- */
        #sidePanel {
            width: 320px; display: flex; flex-direction: column; gap: 10px; height: 100%;
        }

        .info-card {
            background: var(--panel-bg); padding: 10px 15px; border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s;
            border-left: 6px solid #ddd; position: relative;
        }
        .player-card.active { transform: scale(1.02); border-color: gold !important; box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
        
        .card-content { display: flex; align-items: center; gap: 10px; }
        .flag { font-size: 26px; }
        .stats h3 { margin: 0; font-size: 15px; color: #2d3436; }
        .stats p { margin: 0; font-size: 13px; color: #636e72; font-weight: bold; }

        .limit-bar-bg { width: 100%; height: 6px; background: #eee; border-radius: 3px; margin-top: 5px; overflow: hidden; border:1px solid #ccc;}
        .limit-bar-fill { height: 100%; width: 0%; background: #00b894; transition: width 0.1s; }

        #turnBadge {
            background: #6c5ce7; color: white; text-align: center; padding: 10px;
            border-radius: 12px; font-size: 15px; box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }

        /* SONU√á KUTUSU */
        #lastResultBox {
            background: white; padding: 10px; border-radius: 15px;
            text-align: center; font-size: 13px; color: #555;
            min-height: 50px; display: flex; align-items: center; justify-content: center; flex-direction: column;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05); border: 2px dashed #ccc;
            transition: all 0.3s;
        }
        #lastResultBox b { font-size: 16px; display: block; margin-bottom: 2px;}
        #lastResultBox.win { background: #dff9fb; border-color: #00b894; color: #009432; }
        #lastResultBox.lose { background: #ffcccc; border-color: #d63031; color: #d63031; }

        /* ZAR ALANI */
        #actionArea { margin-top: auto; text-align: center; position: relative; height: 130px; }
        
        .dice-container {
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%) scale(1.3);
            perspective: 1000px; width: 60px; height: 60px; z-index: 10;
        }
        .dice-box { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; }
        .dice-face {
            position: absolute; width: 100%; height: 100%; background: white;
            border: 2px solid #b2bec3; border-radius: 10px; display: flex;
            justify-content: center; align-items: center; font-size: 24px; font-weight: bold;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.1); color: #2d3436;
        }
        .df1 { transform: translateZ(30px); } .df2 { transform: rotateY(180deg) translateZ(30px); }
        .df3 { transform: rotateY(90deg) translateZ(30px); } .df4 { transform: rotateY(-90deg) translateZ(30px); }
        .df5 { transform: rotateX(90deg) translateZ(30px); } .df6 { transform: rotateX(-90deg) translateZ(30px); }

        #rollBtn {
            position: absolute; bottom: 0; left: 0; width: 100%; padding: 15px;
            border: none; border-radius: 15px; background: #dfe6e9; color: #636e72;
            font-size: 16px; font-weight: bold; cursor: not-allowed; transition: all 0.3s;
        }
        #rollBtn.ready { background: #0984e3; color: white; cursor: pointer; box-shadow: 0 6px 0 #074f83; animation: pulseBtn 1s infinite; }
        #rollBtn:active { transform: translateY(4px); box-shadow: 0 2px 0 #074f83; }

        /* MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            display: flex; justify-content: center; align-items: center; z-index: 100;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-card { background: white; padding: 30px; border-radius: 30px; text-align: center; max-width: 500px; width: 90%; transform: scale(0.8); transition: transform 0.3s; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-overlay.active .modal-card { transform: scale(1); }

        .setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .player-select { background: #f8f9fa; padding: 15px; border-radius: 15px; }
        .primary-btn { background: linear-gradient(45deg, #0984e3, #74b9ff); color: white; border: none; padding: 12px 40px; font-size: 18px; border-radius: 50px; cursor: pointer; box-shadow: 0 5px 15px rgba(9, 132, 227, 0.4); }

        .rules-box { text-align:left; font-size:13px; color:#555; background:#f1f2f6; padding:15px; border-radius:10px; margin-bottom:20px; line-height: 1.6; border: 1px solid #ddd; }
        .rule-row { display: flex; justify-content: space-between; border-bottom: 1px solid #ddd; padding: 3px 0; }
        .rule-win { color: #009432; font-weight: bold; }
        .rule-lose { color: #d63031; font-weight: bold; }

        @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        @media (max-width: 768px) {
            #gameLayout { flex-direction: column; height: auto; }
            #sidePanel { width: 100%; height: auto; flex-direction: column; }
            #actionArea { height: 100px; }
            .dice-container { top: -20px; transform: translateX(-50%) scale(1.2); }
        }
    </style>
</head>
<body>

    <div id="setupModal" class="modal-overlay active">
        <div class="modal-card">
            <h1 style="color:#2c3e50; margin:0;">üåç Boyama Sava≈ülarƒ±</h1>
            <p style="color:#7f8c8d;">Risk ve Strateji</p>
            
            <div class="setup-grid">
                <div class="player-select" style="border: 2px solid var(--p1-color);">
                    <h4 style="margin:0; color:#ff6b6b">Oyuncu 1</h4>
                    <div style="font-size:40px; margin:10px 0;" id="p1FlagPreview">‚ùì</div>
                    <select id="p1Select" onchange="updatePreview('p1')" style="width:100%"></select>
                </div>
                <div class="player-select" style="border: 2px solid var(--p2-color);">
                    <h4 style="margin:0; color:#48dbfb">Oyuncu 2</h4>
                    <div style="font-size:40px; margin:10px 0;" id="p2FlagPreview">‚ùì</div>
                    <select id="p2Select" onchange="updatePreview('p2')" style="width:100%"></select>
                </div>
            </div>
            
            <div class="rules-box">
                <div style="margin-bottom:5px; text-align:center;"><b>üé≤ ZAR SONU√áLARI</b></div>
                <div class="rule-row"><span>1Ô∏è‚É£</span> <span class="rule-win">Tam Kazan (Se√ßtiƒüini Al)</span></div>
                <div class="rule-row"><span>2Ô∏è‚É£</span> <span class="rule-lose">Tam Kaybet (Se√ßtiƒüin Silinir)</span></div>
                <div class="rule-row"><span>3Ô∏è‚É£</span> <span class="rule-win">üî• 2 KAT KAZAN (B√ºy√ºr)</span></div>
                <div class="rule-row"><span>4Ô∏è‚É£</span> <span class="rule-lose">üíÄ 2 KAT KAYBET (B√ºy√ºy√ºp Silinir)</span></div>
                <div class="rule-row"><span>5Ô∏è‚É£</span> <span class="rule-win">¬Ω Yarƒ±m Kazan (K√º√ß√ºl√ºr)</span></div>
                <div class="rule-row"><span>6Ô∏è‚É£</span> <span class="rule-lose">¬Ω Yarƒ±m Kaybet (K√º√ß√ºl√ºp Silinir)</span></div>
            </div>

            <button class="primary-btn" onclick="finishSetup()">BA≈ûLAT üöÄ</button>
        </div>
    </div>

    <div id="tugOfWarBar">
        <div id="barP1">P1 %50</div>
        <div id="barCenter"></div>
        <div id="barP2">P2 %50</div>
    </div>

    <div id="gameLayout">
        <div id="canvasWrapper">
            <canvas id="bgCanvas"></canvas> <canvas id="mapCanvas"></canvas> <canvas id="uiCanvas"></canvas> <canvas id="fxCanvas" style="pointer-events: none;"></canvas> </div>

        <div id="sidePanel">
            <div id="turnBadge">Sƒ±ra: Bekleniyor</div>

            <div id="p1Card" class="info-card player-card active" style="border-color: var(--p1-color);">
                <div class="card-content">
                    <div class="flag" id="p1FlagDisp">üè≥Ô∏è</div>
                    <div class="stats" style="flex-grow:1">
                        <h3 id="p1NameDisp">Oyuncu 1</h3>
                        <p id="p1Score">---</p>
                    </div>
                </div>
                <div class="limit-bar-bg"><div id="p1LimitBar" class="limit-bar-fill"></div></div>
            </div>

            <div id="p2Card" class="info-card player-card" style="border-color: var(--p2-color);">
                <div class="card-content">
                    <div class="flag" id="p2FlagDisp">üè≥Ô∏è</div>
                    <div class="stats" style="flex-grow:1">
                        <h3 id="p2NameDisp">Oyuncu 2</h3>
                        <p id="p2Score">---</p>
                    </div>
                </div>
                <div class="limit-bar-bg"><div id="p2LimitBar" class="limit-bar-fill"></div></div>
            </div>

            <div id="lastResultBox">Sava≈ü ba≈ülƒ±yor...</div>

            <div id="actionArea">
                <div class="dice-container">
                    <div class="dice-box" id="gameDice">
                        <div class="dice-face df1">1</div>
                        <div class="dice-face df2">2</div>
                        <div class="dice-face df3">3</div>
                        <div class="dice-face df4">4</div>
                        <div class="dice-face df5">5</div>
                        <div class="dice-face df6">6</div>
                    </div>
                </div>
                <button id="rollBtn">√ñNCE ALAN √áƒ∞Z üñåÔ∏è</button>
            </div>
        </div>
    </div>

<script>
// --- VERƒ∞ ---
const COUNTRIES = [
    { code: 'TR', name: 'T√ºrkiye', flag: 'üáπüá∑' }, { code: 'AZ', name: 'Azerbaycan', flag: 'üá¶üáø' },
    { code: 'US', name: 'ABD', flag: 'üá∫üá∏' }, { code: 'DE', name: 'Almanya', flag: 'üá©üá™' },
    { code: 'JP', name: 'Japonya', flag: 'üáØüáµ' }, { code: 'KR', name: 'G√ºney Kore', flag: 'üá∞üá∑' },
    { code: 'BR', name: 'Brezilya', flag: 'üáßüá∑' }, { code: 'RU', name: 'Rusya', flag: 'üá∑üá∫' },
    { code: 'CN', name: '√áin', flag: 'üá®üá≥' }, { code: 'FR', name: 'Fransa', flag: 'üá´üá∑' },
    { code: 'IN', name: 'Hindistan', flag: 'üáÆüá≥' }, { code: 'GB', name: 'ƒ∞ngiltere', flag: 'üá¨üáß' },
    { code: 'IT', name: 'ƒ∞talya', flag: 'üáÆüáπ' }, { code: 'ES', name: 'ƒ∞spanya', flag: 'üá™üá∏' },
    { code: 'MX', name: 'Meksika', flag: 'üá≤üáΩ' }, { code: 'CA', name: 'Kanada', flag: 'üá®üá¶' }
];

const p1Sel = document.getElementById('p1Select');
const p2Sel = document.getElementById('p2Select');
COUNTRIES.forEach((c, i) => { p1Sel.add(new Option(c.name, i)); p2Sel.add(new Option(c.name, i)); });
p1Sel.selectedIndex = 0; p2Sel.selectedIndex = 1;
updatePreview('p1'); updatePreview('p2');

function updatePreview(p) {
    const idx = document.getElementById(p+'Select').value;
    document.getElementById(p+'FlagPreview').innerText = COUNTRIES[idx].flag;
}

let player1 = {}, player2 = {};
let gameState = {
    started: false,
    readyToPlay: false, // BUG FIX: Ba≈ülangƒ±√ßta game over olmasƒ±n
    turn: 'p1',
    isDrawing: false,
    pathPoints: [],
    canRoll: false,
    isRolling: false,
    scores: { p1: 100000, p2: 100000 }, // Ba≈ülangƒ±√ßta y√ºksek deƒüer (g√ºvenli)
    limitRatio: 1.0 // TAM Kendi alanƒ± kadar
};

// --- SES Sƒ∞STEMƒ∞ (Sweet Sounds) ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playTone(freq, type, duration, delay=0, vol=0.1) {
    if(audioCtx.state==='suspended') audioCtx.resume();
    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.type=type; o.frequency.setValueAtTime(freq, audioCtx.currentTime+delay);
    g.gain.setValueAtTime(0, audioCtx.currentTime+delay);
    g.gain.linearRampToValueAtTime(vol, audioCtx.currentTime+delay+0.05);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+delay+duration);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(audioCtx.currentTime+delay); o.stop(audioCtx.currentTime+delay+duration);
}

function playSound(ev) {
    if(ev==='draw') playTone(400+Math.random()*200, 'sine', 0.05, 0, 0.05);
    if(ev==='tick') playTone(800, 'square', 0.02, 0, 0.05);
    if(ev==='ready') playTone(1000, 'sine', 0.2);
    if(ev==='win') { playTone(523.25, 'sine', 0.3, 0, 0.2); playTone(659.25, 'sine', 0.3, 0.1, 0.2); }
    if(ev==='winBig') { playTone(523.25, 'triangle', 0.3, 0, 0.2); playTone(1046.50, 'triangle', 0.5, 0.2, 0.2); }
    if(ev==='lose') { playTone(400, 'sine', 0.3, 0, 0.2); playTone(300, 'sine', 0.5, 0.1, 0.2); }
    if(ev==='loseBig') { playTone(300, 'sawtooth', 0.4, 0, 0.1); playTone(150, 'sawtooth', 0.6, 0.2, 0.1); }
    if(ev==='start') { playTone(600, 'sine', 0.5); }
    if(ev==='limit') { playTone(200, 'sawtooth', 0.1); }
}

// --- CANVAS SETUP ---
const bgCanvas = document.getElementById('bgCanvas');
const mapCanvas = document.getElementById('mapCanvas');
const uiCanvas = document.getElementById('uiCanvas');
const fxCanvas = document.getElementById('fxCanvas');
const ctxBg = bgCanvas.getContext('2d');
const ctxMap = mapCanvas.getContext('2d', { willReadFrequently: true });
const ctxUi = uiCanvas.getContext('2d');
const ctxFx = fxCanvas.getContext('2d');

function finishSetup() {
    const idx1 = p1Sel.value; const idx2 = p2Sel.value;
    player1 = { ...COUNTRIES[idx1], color: '#ff7675' };
    player2 = { ...COUNTRIES[idx2], color: '#74b9ff' };
    
    document.getElementById('p1NameDisp').innerText = player1.name;
    document.getElementById('p1FlagDisp').innerText = player1.flag;
    document.getElementById('p2NameDisp').innerText = player2.name;
    document.getElementById('p2FlagDisp').innerText = player2.flag;
    document.getElementById('setupModal').classList.remove('active');
    
    gameState.started = true;
    resize();
    
    // SAFE INIT: Harita oturduktan sonra puan hesapla
    setTimeout(() => { 
        drawInitialAreas(); 
        setTimeout(() => {
            updateScores(); 
            gameState.readyToPlay = true; 
        }, 300);
    }, 100);

    updateTurnIndicator();
    playSound('start');
}

function resize() {
    const w = document.getElementById('canvasWrapper');
    [bgCanvas, mapCanvas, uiCanvas, fxCanvas].forEach(c => { c.width = w.clientWidth; c.height = w.clientHeight; });
    if(gameState.started) { drawWorldMap(); drawInitialAreas(); }
}
window.addEventListener('resize', resize);

function drawWorldMap() {
    ctxBg.clearRect(0,0,bgCanvas.width, bgCanvas.height);
    
    // Grid
    ctxBg.strokeStyle = 'rgba(255,255,255,0.1)'; ctxBg.lineWidth=1;
    for(let i=0; i<bgCanvas.width; i+=60) { ctxBg.beginPath(); ctxBg.moveTo(i,0); ctxBg.lineTo(i,bgCanvas.height); ctxBg.stroke(); }
    for(let i=0; i<bgCanvas.height; i+=60) { ctxBg.beginPath(); ctxBg.moveTo(0,i); ctxBg.lineTo(bgCanvas.width,i); ctxBg.stroke(); }

    // Kƒ±talar (Ye≈üil Alanlar)
    ctxBg.fillStyle = '#badc58'; // Kara
    const lands = [{x:0.2,y:0.3,r:90}, {x:0.7,y:0.3,r:100}, {x:0.6,y:0.7,r:80}, {x:0.25,y:0.65,r:70}];
    lands.forEach(l => {
        let cx = l.x*bgCanvas.width; let cy=l.y*bgCanvas.height;
        if(Math.hypot(cx,cy-bgCanvas.height)<250 || Math.hypot(cx-bgCanvas.width, cy)<250) return;
        ctxBg.beginPath();
        for(let a=0; a<Math.PI*2; a+=0.4) {
            let r = l.r + Math.random()*25;
            ctxBg.lineTo(cx+Math.cos(a)*r, cy+Math.sin(a)*r);
        }
        ctxBg.fill();
    });
    
    // Dekorasyon
    ctxBg.font = "24px Arial"; ctxBg.textAlign="center";
    for(let i=0;i<20;i++) ctxBg.fillText(Math.random()>.5?"üå≤":"‚õ∞Ô∏è", Math.random()*bgCanvas.width, Math.random()*bgCanvas.height);
}

function drawInitialAreas() {
    // Sol Alt (P1)
    ctxMap.fillStyle = player1.color; 
    ctxMap.beginPath(); ctxMap.arc(0, mapCanvas.height, 180, 0, Math.PI*2); ctxMap.fill();
    
    // Saƒü √úst (P2)
    ctxMap.fillStyle = player2.color; 
    ctxMap.beginPath(); ctxMap.arc(mapCanvas.width, 0, 180, 0, Math.PI*2); ctxMap.fill();
}

// --- √áƒ∞Zƒ∞M VE Lƒ∞Mƒ∞T HESAPLAMA ---
function getMousePos(e) {
    const r = uiCanvas.getBoundingClientRect();
    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: cx - r.left, y: cy - r.top };
}

uiCanvas.addEventListener('mousedown', startD); uiCanvas.addEventListener('mousemove', moveD); uiCanvas.addEventListener('mouseup', endD);
uiCanvas.addEventListener('touchstart', startD, {passive:false}); uiCanvas.addEventListener('touchmove', moveD, {passive:false}); uiCanvas.addEventListener('touchend', endD);

function startD(e) {
    if(!gameState.started || gameState.canRoll || gameState.isRolling) return;
    if(e.type==='touchstart') e.preventDefault();
    const p = getMousePos(e);
    
    const px = ctxMap.getImageData(p.x, p.y, 1, 1).data;
    const isP1 = (gameState.turn === 'p1' && px[0] > px[2]); // Kƒ±rmƒ±zƒ±
    const isP2 = (gameState.turn === 'p2' && px[2] > px[0]); // Mavi
    if(!isP1 && !isP2) return;

    gameState.isDrawing = true; gameState.pathPoints = [p];
    playSound('draw');
    ctxUi.beginPath(); ctxUi.moveTo(p.x, p.y);
    ctxUi.strokeStyle = '#2d3436'; ctxUi.lineWidth = 3; ctxUi.setLineDash([5,5]);
}

function moveD(e) {
    if(!gameState.isDrawing) return;
    if(e.type==='touchmove') e.preventDefault();
    const p = getMousePos(e);
    gameState.pathPoints.push(p);
    
    // Limit Kontrol√º (Hata d√ºzeltildi: Ger√ßek Piksel vs Ger√ßek Piksel)
    const currentDrawArea = calculatePolyArea(gameState.pathPoints);
    const maxAllowed = gameState.scores[gameState.turn] * gameState.limitRatio;
    const ratio = Math.min(100, (currentDrawArea / maxAllowed) * 100);
    
    const barId = gameState.turn==='p1'?'p1LimitBar':'p2LimitBar';
    const bar = document.getElementById(barId);
    bar.style.width = ratio + '%';
    
    // G√∂rsel Geri Bildirim
    if (currentDrawArea > maxAllowed) {
        bar.style.background = '#e74c3c'; // Kƒ±rmƒ±zƒ± (Hata)
        ctxUi.strokeStyle = '#e74c3c';
        if(Math.random()>0.9) playSound('limit');
    } else {
        bar.style.background = '#00b894'; // Ye≈üil (OK)
        ctxUi.strokeStyle = '#2d3436';
    }

    ctxUi.clearRect(0,0,uiCanvas.width, uiCanvas.height);
    ctxUi.beginPath(); ctxUi.moveTo(gameState.pathPoints[0].x, gameState.pathPoints[0].y);
    for(let pt of gameState.pathPoints) ctxUi.lineTo(pt.x, pt.y);
    ctxUi.stroke();
}

function endD() {
    if(!gameState.isDrawing) return;
    gameState.isDrawing = false;
    ctxUi.closePath();
    ctxUi.fillStyle = 'rgba(0,0,0,0.1)'; ctxUi.fill();
    
    const area = calculatePolyArea(gameState.pathPoints);
    const maxAllowed = gameState.scores[gameState.turn] * gameState.limitRatio;

    // Reset Bar
    document.getElementById('p1LimitBar').style.width = '0%'; document.getElementById('p2LimitBar').style.width = '0%';

    // Validasyon
    if(area < 100) { ctxUi.clearRect(0,0,uiCanvas.width, uiCanvas.height); return; }
    
    if(area > maxAllowed) { 
        alert("Sƒ±nƒ±rƒ± a≈ütƒ±n! Sadece sahip olduƒüun kadar alanƒ± riske edebilirsin.");
        ctxUi.clearRect(0,0,uiCanvas.width, uiCanvas.height); 
        return; 
    }
    
    gameState.canRoll = true;
    const btn = document.getElementById('rollBtn');
    btn.classList.add('ready');
    // G√∂stermelik birim (1000'e b√∂lerek sadele≈ütirdik)
    btn.innerHTML = `üé≤ ZAR AT (Risk: ${Math.floor(area/100)})`;
    playSound('ready');
}

// --- ZAR VE SONU√á ---
document.getElementById('rollBtn').addEventListener('click', () => {
    if(!gameState.canRoll) return;
    gameState.isRolling = true;
    document.getElementById('rollBtn').classList.remove('ready');
    
    const target = Math.floor(Math.random()*6)+1;
    animateDice(target);
});

function animateDice(target) {
    const box = document.getElementById('gameDice');
    let frame = 0; const duration = 120; // 2 sn
    let vx = 20, vy = 20; let rx = 0, ry = 0;

    const loop = setInterval(() => {
        frame++;
        vx *= 0.98; vy *= 0.98; rx += vx; ry += vy;
        
        // Wobble Effect (Sonlara doƒüru heyecan)
        if(frame > duration - 30) {
            let tx=0, ty=0;
            if(target==1) {tx=0; ty=0;} if(target==2) {tx=0; ty=180;}
            if(target==3) {tx=0; ty=-90;} if(target==4) {tx=0; ty=90;}
            if(target==5) {tx=-90; ty=0;} if(target==6) {tx=90; ty=0;}
            const w = Math.sin(frame)*15;
            box.style.transform = `rotateX(${tx+w+720}deg) rotateY(${ty+w+720}deg) scale(1.2)`;
        } else {
            box.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg) scale(1.2)`;
            if(frame%10===0) playSound('tick');
        }

        if(frame >= duration) {
            clearInterval(loop);
            let tx=0, ty=0;
            if(target==1) {tx=0; ty=0;} if(target==2) {tx=0; ty=180;}
            if(target==3) {tx=0; ty=-90;} if(target==4) {tx=0; ty=90;}
            if(target==5) {tx=-90; ty=0;} if(target==6) {tx=90; ty=0;}
            box.style.transform = `rotateX(${tx+720}deg) rotateY(${ty+720}deg) scale(1)`;
            processResult(target);
        }
    }, 16);
}

function processResult(res) {
    const player = gameState.turn === 'p1' ? player1 : player2;
    const center = getCentroid(gameState.pathPoints);
    const box = document.getElementById('lastResultBox');
    
    let scale = 1, mode = 'source-over', msg = "", sound = "win", color = player.color;

    // --- 1-6 MANTIƒûI ---
    switch(res) {
        case 1: scale=1; mode='source-over'; msg="1Ô∏è‚É£ TAM ƒ∞SABET! Alanƒ± kaptƒ±n."; sound='win'; break;
        case 2: scale=1; mode='destination-out'; msg="2Ô∏è‚É£ KAYIP! Se√ßtiƒüin yer silindi."; sound='lose'; break;
        case 3: scale=1.41; mode='source-over'; msg="3Ô∏è‚É£ 2 KAT KAZAN√á! Muazzam b√ºy√ºme!"; sound='winBig'; break;
        case 4: scale=1.41; mode='destination-out'; msg="4Ô∏è‚É£ 2 KAT KAYIP! B√ºy√ºk hasar!"; sound='loseBig'; break;
        case 5: scale=0.7; mode='source-over'; msg="5Ô∏è‚É£ YARIM KAZAN√á. Olsun, k√¢rdƒ±r."; sound='win'; break;
        case 6: scale=0.7; mode='destination-out'; msg="6Ô∏è‚É£ YARIM KAYIP. Ucuz atlattƒ±n."; sound='lose'; break;
    }

    playSound(sound);
    spawnParticles(center.x, center.y, mode==='source-over'?color:'#555', scale*20);
    
    // Canvas ƒ∞≈ülemi
    ctxMap.save();
    ctxMap.translate(center.x, center.y);
    ctxMap.scale(scale, scale); // B√ºy√ºtme/K√º√ß√ºltme burada yapƒ±lƒ±yor
    ctxMap.translate(-center.x, -center.y);
    
    ctxMap.globalCompositeOperation = mode; // Silme veya Boyama
    ctxMap.fillStyle = color;
    ctxMap.beginPath();
    ctxMap.moveTo(gameState.pathPoints[0].x, gameState.pathPoints[0].y);
    for(let p of gameState.pathPoints) ctxMap.lineTo(p.x, p.y);
    ctxMap.closePath();
    ctxMap.fill();
    
    ctxMap.restore();
    ctxMap.globalCompositeOperation = 'source-over';

    // UI G√ºncelle
    box.innerHTML = `<b>${player.name} (${res}):</b> ${msg}`;
    box.className = mode==='source-over'?'win':'lose';

    setTimeout(() => {
        ctxUi.clearRect(0,0,uiCanvas.width, uiCanvas.height);
        gameState.pathPoints = []; gameState.canRoll = false; gameState.isRolling = false;
        document.getElementById('rollBtn').innerHTML = "√ñNCE ALAN √áƒ∞Z üñåÔ∏è";
        updateScores(); switchTurn();
    }, 1800);
}

// --- YARDIMCI ---
function getCentroid(pts) {
    let x=0, y=0; for(let p of pts){x+=p.x; y+=p.y;}
    return {x:x/pts.length, y:y/pts.length};
}

function calculatePolyArea(pts) {
    let a=0;
    for(let i=0; i<pts.length; i++) {
        let j=(i+1)%pts.length; a += pts[i].x*pts[j].y; a -= pts[j].x*pts[i].y;
    }
    return Math.abs(a/2);
}

function updateScores() {
    // Sadece oyun hazƒ±rken √ßalƒ±≈ü
    if (!gameState.readyToPlay && gameState.scores.p1 > 0) return;

    // Ger√ßek piksel sayƒ±mƒ± (Hassas √∂l√ß√ºm)
    const d = ctxMap.getImageData(0,0,mapCanvas.width, mapCanvas.height).data;
    let s1=0, s2=0, step=64; // √ñrnekleme hƒ±zƒ± (performans/doƒüruluk dengesi)
    
    for(let i=0; i<d.length; i+=step) {
        if(d[i+3]>50) { if(d[i]>d[i+2]) s1++; else s2++; }
    }
    
    // Piksel sayƒ±sƒ±nƒ± √∂rnekleme oranƒ±yla √ßarpƒ±p ger√ßek alana yakla≈ütƒ±r
    // step = 64 (her 16 pikselden 1'i, rgba 4 byte olduƒüu i√ßin 64/4 = 16)
    const realS1 = s1 * 16;
    const realS2 = s2 * 16;

    gameState.scores.p1 = realS1;
    gameState.scores.p2 = realS2;
    
    document.getElementById('p1Score').innerText = Math.floor(realS1/1000) + " br";
    document.getElementById('p2Score').innerText = Math.floor(realS2/1000) + " br";
    
    // Bar
    const total = realS1 + realS2 + 1;
    document.getElementById('barP1').style.width = (realS1/total)*100+"%";
    document.getElementById('barP1').innerText = player1.name + " %" + Math.round((realS1/total)*100);
    document.getElementById('barP2').style.width = (realS2/total)*100+"%";
    document.getElementById('barP2').innerText = "%" + Math.round((realS2/total)*100) + " " + player2.name;

    // Game Over
    if(gameState.readyToPlay) {
        if(realS1 < 5000) { alert("üèÜ " + player2.name + " KAZANDI!"); location.reload(); }
        if(realS2 < 5000) { alert("üèÜ " + player1.name + " KAZANDI!"); location.reload(); }
    }
}

function switchTurn() {
    gameState.turn = gameState.turn === 'p1' ? 'p2' : 'p1';
    updateTurnIndicator();
}

function updateTurnIndicator() {
    const badge = document.getElementById('turnBadge');
    document.getElementById('p1Card').classList.remove('active');
    document.getElementById('p2Card').classList.remove('active');
    
    if(gameState.turn === 'p1') {
        badge.innerHTML = `Sƒ±ra: ${player1.flag} ${player1.name}`;
        badge.style.background = player1.color;
        document.getElementById('p1Card').classList.add('active');
    } else {
        badge.innerHTML = `Sƒ±ra: ${player2.flag} ${player2.name}`;
        badge.style.background = player2.color;
        document.getElementById('p2Card').classList.add('active');
    }
}

// --- EFEKTLER ---
let particles = [];
function spawnParticles(x,y,c, count=20) {
    for(let i=0;i<count;i++) particles.push({x:x,y:y,vx:(Math.random()-.5)*15,vy:(Math.random()-.5)*15,life:1,c:c});
}
function loopFx() {
    ctxFx.clearRect(0,0,fxCanvas.width,fxCanvas.height);
    particles.forEach(p=>{
        p.x+=p.vx; p.y+=p.vy; p.life-=0.04;
        ctxFx.globalAlpha=p.life; ctxFx.fillStyle=p.c; 
        ctxFx.beginPath(); ctxFx.arc(p.x,p.y,4,0,Math.PI*2); ctxFx.fill();
    });
    particles=particles.filter(p=>p.life>0);
    requestAnimationFrame(loopFx);
}
loopFx();

</script>
</body>
</html>
